
istio_job_template: &istio_job_template
  branches:
  - "^master$"
  decorate: true
  path_alias: istio.io/istio

istio_container: &istio_container
  image: gcr.io/istio-testing/istio-builder:v20181008-db31a9fd
  # Docker in Docker
  securityContext:
    privileged: true
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "24Gi"
      cpu: "7000m"

test_infra_master_spec: &test_infra_master_spec
  containers:
  - image: gcr.io/istio-testing/prowbazel:0.4.13
    args:
    - "--repo=github.com/istio/test-infra=master"
    - "--clean"
    - "--timeout=30"
    # Bazel needs privileged mode in order to sandbox builds.
    securityContext:
      privileged: true
  nodeSelector:
    testing: test-pool

periodics:

- interval: 10m
  name: test-infra-cleanup-GKE
  labels:
    preset-service-account: "true"
  spec:
    <<: *test_infra_master_spec

- interval: 1h
  name: test-infra-update-deps
  labels:
    preset-service-account: "true"
  spec:
    containers:
    - image: gcr.io/istio-testing/prowbazel:0.4.13
      args:
      - "--repo=github.com/istio/test-infra=master"
      - "--clean"
      - "--timeout=20"
      securityContext:
        privileged: true
      env:
      - name: GIT_BRANCHES
        value: master,release-0.8,release-1.0
      - name: GIT_BRANCH
        value: master
      volumeMounts:
      - name: oauth
        mountPath: /etc/github
        readOnly: true
    volumes:
    - name: oauth
      secret:
        secretName: oauth-token
    nodeSelector:
      testing: test-pool

- interval: 24h
  name: gcr_cleanup_istio_testing
  labels:
    preset-service-account: "true"
  spec:
    containers:
    - image: gcr.io/istio-testing/prowbazel:0.4.13
      args:
      - "--repo=github.com/istio/test-infra=master"
      - "--clean"
      - "--timeout=1400"
      securityContext:
        privileged: false
      env:
      - name: GIT_BRANCH
        value: master
      volumeMounts:
      - name: oauth
        mountPath: /etc/github
        readOnly: true
    volumes:
    - name: oauth
      secret:
        secretName: oauth-token
    nodeSelector:
      testing: test-pool

  name: proxy-postsubmit-periodic
  context: prow/proxy-postsubmit.sh
  branches: master
  labels:
    preset-service-account: "true"
  spec:
    containers:
    - image: gcr.io/istio-testing/prowbazel:0.4.13
      args:
      - "--repo=github.com/istio/proxy"
      - "--clean"
      - "--timeout=120"
      # Bazel needs privileged mode in order to sandbox builds.
      securityContext:
        privileged: true
      resources:
        requests:
          memory: "512Mi"
          cpu: "500m"
        limits:
          memory: "24Gi"
          cpu: "7000m"
    nodeSelector:
      testing: build-pool

  name: api-postsubmit-periodic
  branches: master
  labels:
      preset-service-account: "true"
  spec:
    containers:
    - image: gcr.io/istio-testing/prowbazel:0.4.13
      args:
      - "--repo=github.com/istio/api"
      - "--clean"
      - "--timeout=90"
      # Bazel needs privileged mode in order to sandbox builds.
      securityContext:
        privileged: true
    nodeSelector:
      testing: test-pool

  name: istio-postsubmit-periodic
  <<: *istio_job_template
  labels:
    preset-service-account: "true"
  spec:
    containers:
    - <<: *istio_container
      command:
      - entrypoint
      - prow/istio-postsubmit.sh
    nodeSelector:
      testing: test-pool
  run_after_success:
  - name: e2e-simpleTests-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/e2e-simpleTests.sh
      nodeSelector:
        testing: test-pool
  - name: e2e-simpleTests-mcp-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    max_concurrency: 5
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/e2e-simpleTests-mcp.sh
      nodeSelector:
        testing: test-pool
  - name: e2e-bookInfoTests-envoyv2-v1alpha3-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/e2e-bookInfoTests-envoyv2-v1alpha3.sh
      nodeSelector:
        testing: test-pool
  - name: istio-pilot-e2e-envoyv2-v1alpha3-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/istio-pilot-e2e-envoyv2-v1alpha3.sh
      nodeSelector:
        testing: test-pool
  - name: istio-pilot-e2e-envoyv2-v1alpha3-k8s-latest-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/istio-pilot-e2e-envoyv2-v1alpha3-k8s-latest.sh
      nodeSelector:
        testing: test-pool
  - name: e2e-bookInfoTests-envoyv2-v1alpha3-mcp-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    max_concurrency: 5
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/e2e-bookInfoTests-envoyv2-v1alpha3-mcp.sh
      nodeSelector:
        testing: test-pool
  - name: e2e-mixer-no_auth-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/e2e-mixer-no_auth.sh
      nodeSelector:
        testing: test-pool
  - name: e2e-dashboard-periodic
    <<: *istio_job_template
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/e2e-dashboard.sh
      nodeSelector:
        testing: test-pool
