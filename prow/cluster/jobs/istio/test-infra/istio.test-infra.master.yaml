test_infra_container: &test_infra_container
  image: gcr.io/istio-testing/test-infra-builder:0.6
  # Bazel needs privileged mode in order to sandbox builds.
  securityContext:
    privileged: true
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "24Gi"
      cpu: "7000m"

branch_spec: &branch_spec
- "^master$"

presubmits:

  istio/test-infra:

  - name: build-test
    agent: kubernetes
    context: "prow: build-test"
    always_run: true
    rerun_command: "/test build-test"
    trigger: "(?m)^/(retest|test (all|build-test))?,?(\\s+|$)"
    decorate: true
    path_alias: istio.io/test-infra
    branches: *branch_spec
    labels:
      preset-prow-bazel: "true"
    spec:
      containers:
      - <<: *test_infra_container
        command:
        - entrypoint
        - prow/build-test.sh
      nodeSelector:
        testing: build-pool

  - name: lint-check
    agent: kubernetes
    context: "prow: lint-check"
    always_run: true
    rerun_command: "/test lint-check"
    trigger: "(?m)^/(retest|test (all|lint-check))?,?(\\s+|$)"
    decorate: true
    path_alias: istio.io/test-infra
    branches: *branch_spec
    labels:
      preset-bazel: "true"
    spec:
      containers:
      - <<: *test_infra_container
        command:
        - entrypoint
        - scripts/linters.sh
      nodeSelector:
        testing: build-pool

postsubmits:

