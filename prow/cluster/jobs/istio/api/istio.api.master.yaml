
test_spec: &test_spec
  containers:
  - image: gcr.io/istio-testing/prowbazel:0.5.8
    args:
    - "--repo=github.com/$(REPO_OWNER)/$(REPO_NAME)=$(PULL_REFS)"
    - "--clean"
    - "--timeout=90"
    # Bazel needs privileged mode in order to sandbox builds.
    securityContext:
      privileged: true
  nodeSelector:
    testing: test-pool

branch_spec: &branch_spec
- "^master$"

presubmits:

  istio/api:

  - name: api-presubmit
    annotations:
      testgrid-dashboards: istio-api-presubmits
    context: prow/api-presubmit.sh
    branches: *branch_spec
    always_run: true
    labels:
      preset-service-account: "true"
    spec:
      <<: *test_spec

postsubmits:

  istio/api:

  - name: api-postsubmit
    annotations:
      testgrid-dashboards: istio-api-postsubmits
      testgrid-alert-email: istio-oncall@googlegroups.com
      testgrid-num-failures-to-alert: '1'
    branches: *branch_spec
    labels:
      preset-service-account: "true"
    spec:
      <<: *test_spec
