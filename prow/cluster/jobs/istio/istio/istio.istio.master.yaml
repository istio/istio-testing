job_template: &job_template
  agent: kubernetes
  branches:
  - "^master$"
  decorate: true
  path_alias: istio.io/istio

istio_container: &istio_container
  image: gcr.io/istio-testing/istio-builder:0.5
  # Docker in Docker
  securityContext:
    privileged: true
  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "24Gi"
      cpu: "7000m"

presubmits:

  istio/istio:

  - name: istio-unit-tests
    <<: *job_template
    context: prow/istio-unit-tests.sh
    always_run: true
    rerun_command: "/test istio-unit-tests"
    trigger: "(?m)^/(retest|test (all|istio-unit-tests))?,?(\\s+|$)"
    labels:
      preset-istio-kubeconfig: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/istio-unit-tests.sh
      nodeSelector:
        testing: build-pool

  - name: test-e2e-mixer-no_auth
    <<: *job_template
    optional: true
    skip_report: true
    context: "prow: test-e2e-mixer-no_auth"
    rerun_command: "/test test-e2e-mixer-no_auth"
    trigger: "(?m)^/test (test-e2e-mixer-no_auth)?,?(\\s+|$)"
    max_concurrency: 5
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/test-e2e-mixer-no_auth.sh
      nodeSelector:
        testing: test-pool

  - name: istio-presubmit
    <<: *job_template
    context: prow/istio-presubmit.sh
    always_run: true
    rerun_command: "/test istio-presubmit"
    trigger: "(?m)^/(retest|test (all|istio-presubmit))?,?(\\s+|$)"
    labels:
      preset-service-account: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/istio-presubmit.sh
      nodeSelector:
        testing: build-pool
    run_after_success:
    - name: istio-pilot-e2e-envoyv2-v1alpha3
      <<: *job_template
      always_run: true
      context: prow/istio-pilot-e2e-envoyv2-v1alpha3.sh
      rerun_command: "/test istio-pilot-e2e-envoyv2-v1alpha3"
      trigger: "(?m)^/test (istio-pilot-e2e-envoyv2-v1alpha3)?,?(\\s+|$)"
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/istio-pilot-e2e-envoyv2-v1alpha3.sh
        nodeSelector:
          testing: test-pool
    - name: istio-pilot-e2e-envoyv2-v1alpha3-mcp
      <<: *job_template
      always_run: true
      context: prow/istio-pilot-e2e-envoyv2-v1alpha3-mcp.sh
      rerun_command: "/test istio-pilot-e2e-envoyv2-v1alpha3-mcp"
      trigger: "(?m)^/test (istio-pilot-e2e-envoyv2-v1alpha3-mcp)?,?(\\s+|$)"
      optional: true
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/istio-pilot-e2e-envoyv2-v1alpha3-mcp.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-mixer-no_auth
      <<: *job_template
      always_run: true
      context: prow/e2e-mixer-no_auth.sh
      rerun_command: "/test e2e-mixer-no_auth"
      trigger: "(?m)^/test (e2e-mixer-no_auth)?,?(\\s+|$)"
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-mixer-no_auth.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-mixer-no_auth-mcp
      <<: *job_template
      always_run: true
      context: prow/e2e-mixer-no_auth-mcp.sh
      rerun_command: "/test e2e-mixer-no_auth-mcp"
      trigger: "(?m)^/test (e2e-mixer-no_auth-mcp)?,?(\\s+|$)"
      optional: true
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-mixer-no_auth-mcp.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-dashboard
      <<: *job_template
      always_run: true
      context: prow/e2e-dashboard.sh
      rerun_command: "/test e2e-dashboard"
      trigger: "(?m)^/test (e2e-dashboard)?,?(\\s+|$)"
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-dashboard.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-bookInfoTests-envoyv2-v1alpha3
      <<: *job_template
      always_run: true
      context: prow/e2e-bookInfoTests-v1alpha3.sh
      rerun_command: "/test e2e-bookInfo-envoyv2-v1alpha3"
      trigger: "(?m)^/test (e2e-bookInfo-envoyv2-v1alpha3)?,?(\\s+|$)"
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-bookInfoTests-envoyv2-v1alpha3.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-simpleTests
      <<: *job_template
      always_run: true
      context: prow/e2e-simpleTests.sh
      rerun_command: "/test e2e-simple"
      trigger: "(?m)^/test (e2e-simple)?,?(\\s+|$)"
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-simpleTests.sh
        nodeSelector:
          testing: test-pool
    - name: istio-pilot-multicluster-e2e
      <<: *job_template
      always_run: true
      context: prow/istio-pilot-multicluster-e2e.sh
      optional: true
      rerun_command: "/test istio-pilot-multicluster-e2e"
      trigger: "(?m)^/test (istio-pilot-multicluster-e2e)?,?(\\s+|$)"
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/istio-pilot-multicluster-e2e.sh
        nodeSelector:
          testing: test-pool


postsubmits:

  istio/istio:

  - name: istio-postsubmit
    <<: *job_template
    labels:
      preset-service-account: "true"
      preset-istio-kubeconfig: "true"
    spec:
      containers:
      - <<: *istio_container
        command:
        - entrypoint
        - prow/istio-postsubmit.sh
      nodeSelector:
        testing: test-pool
    run_after_success:
    - name: e2e-simpleTests
      <<: *job_template
      labels:
        preset-service-account: "true"
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-simpleTests.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-simpleTests-mcp
      <<: *job_template
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-simpleTests-mcp.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-bookInfoTests-envoyv2-v1alpha3
      <<: *job_template
      labels:
        preset-service-account: "true"
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-bookInfoTests-envoyv2-v1alpha3.sh
        nodeSelector:
          testing: test-pool
    - name: istio-pilot-e2e-envoyv2-v1alpha3
      <<: *job_template
      labels:
        preset-service-account: "true"
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/istio-pilot-e2e-envoyv2-v1alpha3.sh
        nodeSelector:
          testing: test-pool
    - name: istio-pilot-e2e-envoyv2-v1alpha3-k8s-1.10
      <<: *job_template
      labels:
        preset-service-account: "true"
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/istio-pilot-e2e-envoyv2-v1alpha3-k8s-1.10.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-bookInfoTests-envoyv2-v1alpha3-mcp
      <<: *job_template
      labels:
        preset-service-account: "true"
      max_concurrency: 5
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-bookInfoTests-envoyv2-v1alpha3-mcp.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-mixer-no_auth
      <<: *job_template
      labels:
        preset-service-account: "true"
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-mixer-no_auth.sh
        nodeSelector:
          testing: test-pool
    - name: e2e-dashboard
      <<: *job_template
      labels:
        preset-service-account: "true"
      spec:
        containers:
        - <<: *istio_container
          command:
          - entrypoint
          - prow/e2e-dashboard.sh
        nodeSelector:
          testing: test-pool
